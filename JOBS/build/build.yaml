- name: build
  hosts: localhost
  remote_user: ans
  vars:
    - version: "{{ CI_COMMIT_SHA }}"
    - work_dir: "/tmp"
    - build_tag: "build-sphere-backend-{{ CI_COMMIT_SHORT_SHA }}"
    - build_dir: "{{ work_dir }}/{{ build_tag }}_{{ ansible_date_time.date }}_{{ ansible_date_time.hour }}-{{ ansible_date_time.minute }}"
    - repo: "{{ CI_REPOSITORY_URL|regex_replace('(https:\\/\\/)(.*)@(.*)', 'ssh://git@\\3') }}"

  tasks:
    - git:
        repo: "{{ repo }}"
        dest: "{{ build_dir }}"
        version: "{{ version }}"
        accept_hostkey: true
        force: yes

    - copy:
        src: .env.local
        dest: "{{ build_dir }}/app/.env.local"

    - copy:
        src: auth.json
        dest: "{{ build_dir }}/app/auth.json"

    - name: composer install
      raw: cd "{{ build_dir }}/app" && php8.2 /usr/local/bin/composer install --no-interaction
      register: composer_install

    - debug: var=composer_install.stdout_lines
